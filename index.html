<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Full Screen Chat App</title>
  <style>
    /* Reset margins and set full-screen dimensions */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    /* Main container with flex layout */
    #container {
      display: flex;
      width: 100vw;
      height: 100vh;
    }
    /* Friend Panel (left) - Gray background */
    #friend-panel {
      width: 250px;
      background-color: #444;  /* Gray background */
      padding: 10px;
      border-right: 1px solid #333;
      overflow-y: auto;
    }
    #friend-panel h2 {
      margin-top: 0;
      color: #fff;
    }
    #friend-panel input, #friend-panel button {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: #222;
      color: #fff;
    }
    #friend-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #friend-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      background: #222;
      margin-bottom: 5px;
      border-radius: 4px;
    }
    #friend-list button {
      padding: 4px 8px;
      border: none;
      background-color: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #friend-list button:hover {
      background-color: #0069d9;
    }
    /* Chat Panel (right) */
    #chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #000;
      color: #fff;
    }
    #chat-header {
      padding: 10px;
      background-color: #1a1a1a;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chat-header h2 {
      margin: 0;
      font-size: 1.2em;
    }
    #chat-header button {
      padding: 6px 12px;
      border: none;
      background-color: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #chat-header button:hover {
      background-color: #0069d9;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      margin: 0;
      list-style: none;
      background-color: #000;
    }
    #messages li {
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 4px;
      background: #333;
    }
    #form {
      display: flex;
      padding: 10px;
      border-top: 1px solid #333;
    }
    #input {
      flex: 1;
      padding: 10px;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: #222;
      color: #fff;
    }
    #send-btn {
      padding: 10px 20px;
      margin-left: 10px;
      border: none;
      background-color: #28a745;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #send-btn:hover {
      background-color: #218838;
    }
    /* Username modal styling */
    #username-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 3;
    }
    #username-modal-content {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    #username-modal-content input {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: #222;
      color: #fff;
    }
    #username-modal-content button {
      padding: 10px 20px;
      border: none;
      background-color: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #username-modal-content button:hover {
      background-color: #0069d9;
    }
  </style>
</head>
<body>
  <!-- Username Modal -->
  <div id="username-modal">
    <div id="username-modal-content">
      <h2>Choose Your Username</h2>
      <input id="username-input" type="text" placeholder="Enter username" />
      <br />
      <button id="username-btn">Save Username</button>
    </div>
  </div>

  <!-- Main Container -->
  <div id="container">
    <!-- Friend Panel -->
    <div id="friend-panel">
      <h2>Friends</h2>
      <input id="friend-input" type="text" placeholder="Add friend username" />
      <button id="add-friend-btn">Add Friend</button>
      <ul id="friend-list"></ul>
    </div>

    <!-- Chat Panel -->
    <div id="chat-panel">
      <div id="chat-header">
        <h2 id="chat-title">Global Chat</h2>
        <button id="global-chat-btn" style="display: none;">Global Chat</button>
      </div>
      <ul id="messages"></ul>
      <form id="form" action="">
        <input id="input" autocomplete="off" placeholder="Type your message..." />
        <button id="send-btn">Send</button>
      </form>
    </div>
  </div>

  <!-- Socket.io Client Library -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    /* ============================
       Username Setup
    ============================ */
    const usernameModal = document.getElementById('username-modal');
    const usernameInput = document.getElementById('username-input');
    const usernameBtn = document.getElementById('username-btn');

    let username = localStorage.getItem('username') || '';
    if (!username) {
      usernameModal.style.display = 'flex';
    } else {
      usernameModal.style.display = 'none';
      socket.emit('set username', username);
    }

    usernameBtn.addEventListener('click', () => {
      const userInput = usernameInput.value.trim();
      if (userInput) {
        username = userInput;
        localStorage.setItem('username', username);
        usernameModal.style.display = 'none';
        socket.emit('set username', username);
      }
    });

    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        usernameBtn.click();
      }
    });

    /* ============================
       Friend Functionality
    ============================ */
    let friends = JSON.parse(localStorage.getItem('friends')) || [];
    const friendInput = document.getElementById('friend-input');
    const addFriendBtn = document.getElementById('add-friend-btn');
    const friendListEl = document.getElementById('friend-list');

    function renderFriends() {
      friendListEl.innerHTML = '';
      friends.forEach(friend => {
        const li = document.createElement('li');
        li.textContent = friend;
        const msgBtn = document.createElement('button');
        msgBtn.textContent = 'Message';
        msgBtn.addEventListener('click', () => {
          // Switch to private chat with this friend.
          currentChat = friend;
          document.getElementById('chat-title').textContent = 'Chat with ' + friend;
          document.getElementById('global-chat-btn').style.display = 'inline-block';
          messages.innerHTML = ''; // Optionally clear messages when switching chats.
        });
        li.appendChild(msgBtn);
        friendListEl.appendChild(li);
      });
    }

    addFriendBtn.addEventListener('click', () => {
      const friendName = friendInput.value.trim();
      if (friendName && !friends.includes(friendName)) {
        friends.push(friendName);
        localStorage.setItem('friends', JSON.stringify(friends));
        renderFriends();
        friendInput.value = '';
      }
    });

    renderFriends();

    /* ============================
       Chat Functionality
    ============================ */
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const messages = document.getElementById('messages');
    const chatTitle = document.getElementById('chat-title');
    const globalChatBtn = document.getElementById('global-chat-btn');

    // 'global' for public chat, or set to a friend's username for private chat.
    let currentChat = 'global';

    // Switch back to Global Chat.
    globalChatBtn.addEventListener('click', () => {
      currentChat = 'global';
      chatTitle.textContent = 'Global Chat';
      globalChatBtn.style.display = 'none';
      messages.innerHTML = '';
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!username) {
        alert('Please set a username first!');
        return;
      }
      const messageText = input.value.trim();
      if (messageText === '') return;
      if (currentChat === 'global') {
        socket.emit('chat message', { username, message: messageText });
      } else {
        socket.emit('private message', { to: currentChat, from: username, message: messageText });
      }
      input.value = '';
    });

    // Listen for global messages.
    socket.on('chat message', (msgObj) => {
      if (currentChat === 'global') {
        const item = document.createElement('li');
        item.innerHTML = '<strong>' + msgObj.username + ':</strong> ' + msgObj.message;
        messages.appendChild(item);
        messages.scrollTop = messages.scrollHeight;
      }
    });

    // Listen for private messages.
    socket.on('private message', (msgObj) => {
      if (currentChat === msgObj.from || currentChat === msgObj.to) {
        const item = document.createElement('li');
        if (msgObj.from === username) {
          item.innerHTML = '<em>To ' + msgObj.to + ':</em> ' + msgObj.message;
        } else {
          item.innerHTML = '<em>From ' + msgObj.from + ':</em> ' + msgObj.message;
        }
        messages.appendChild(item);
        messages.scrollTop = messages.scrollHeight;
      }
    });

    // Listen for system messages.
    socket.on('system message', (msgObj) => {
      const item = document.createElement('li');
      item.innerHTML = '<em>' + msgObj.message + '</em>';
      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    });
  </script>
</body>
</html>
